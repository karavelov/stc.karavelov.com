{% extends 'base.html' %}
{% block content %}

<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–∏–≥–Ω–∞–ª</h4>
                <hr>
                <form class="forms-sample" method="POST" action="{% url 'regcomplaint' %}" enctype="multipart/form-data">
                    {% include 'includes/messages.html' %}
                    {% csrf_token %}

                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                    <div class="form-group">
                        <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select name="cat_id" class="form-control" required id="category">
                            <option value="">–ò–∑–±–µ—Ä–µ—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                            {% for i in categories %}
                            <option value="{{ i.id }}">{{ i.catname }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
                    <div class="form-group">
                        <label for="subcategory">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-control" name="subcategory_id" id="subcategory" required>
                            <option value="">–ò–∑–±–µ—Ä–µ—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                        </select>
                    </div>

                    <!-- –ü–æ–ª–µ –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ –≥—Ä–∞–¥ -->
                    <div class="form-group">
                        <label for="city">–ù–∞—Å–µ–ª–µ–Ω–æ –º—è—Å—Ç–æ</label>
                        <select name="city_id" class="form-control" id="city" required>
                            <option value="">–ò–∑–±–µ—Ä–µ—Ç–µ –Ω–∞—Å–µ–ª–µ–Ω–æ –º—è—Å—Ç–æ</option>
                            {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.city_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- –ü–æ–ª–µ –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —É–ª–∏—Ü–∞ -->
                    <div class="form-group">
                        <label for="street">–£–ª–∏—Ü–∞</label>
                        <select name="street_id" class="form-control" id="street" required>
                            <option value="">–ò–∑–±–µ—Ä–µ—Ç–µ —É–ª–∏—Ü–∞</option>
                        </select>
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∞ -->
                    <div class="form-group">
                        <label for="complaindetails">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∞ (–º–∞–∫—Å 2000 –¥—É–º–∏)</label>
                        <textarea name="complaindetails" required cols="10" rows="5" class="form-control"
                            maxlength="2000" placeholder="–û–ø–∏—à–µ—Ç–µ –¥–µ—Ç–∞–π–ª–Ω–æ —Å–∏–≥–Ω–∞–ª–∞..."></textarea>
                    </div>

                    <!-- –§–∞–π–ª –∑–∞ –ø—Ä–∏–∫–∞—á–∞–Ω–µ -->
                    <div class="form-group">
                        <label for="compfile">–ü—Ä–∏–∫–∞—á–µ–Ω–∞ —Å–Ω–∏–º–∫–∞</label>
                        <input type="file" name="compfile" class="form-control" id="compfile" accept="image/*">
                        <img id="preview-image" src="" alt="–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Å–Ω–∏–º–∫–∞—Ç–∞"
                            style="display:none; max-width: 100%; margin-top: 10px;">
                    </div>

                    <button type="submit" class="btn btn-primary mr-2">–ò–∑–ø—Ä–∞—Ç–∏</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript –∑–∞ –¥–∏–Ω–∞–º–∏—á–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –≥—Ä–∞–¥–æ–≤–µ –∏ —É–ª–∏—Ü–∏ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        $('#category').change(function () {
            var cid = $(this).val();
            console.log("üì¢ –ò–∑–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è ID:", cid);

            if (cid) {
                $.ajax({
                    url: '/user/get_subcat/',
                    type: 'GET',
                    data: { 'c_id': cid },
                    headers: { "X-CSRFToken": getCSRFToken() },  // ‚úÖ –î–æ–±–∞–≤—è–º–µ CSRF —Ç–æ–∫–µ–Ω
                    success: function (data) {
                        console.log("üì¢ –û—Ç–≥–æ–≤–æ—Ä –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞:", data);
                        $('#subcategory').html(data.subcat_options);
                    },
                    error: function (xhr, status, error) {
                        console.error("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", xhr.responseText);
                        alert("–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞.");
                    }
                });
            } else {
                $('#subcategory').html('<option value="">–ò–∑–±–µ—Ä–µ—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>');
            }
        });

        // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —É–ª–∏—Ü–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –≥—Ä–∞–¥
        $("#city").change(function () {
            var cityId = $(this).val();
            let streetSelect = $("#street");
            streetSelect.html('<option value="">–ò–∑–±–µ—Ä–µ—Ç–µ —É–ª–∏—Ü–∞</option>');

            if (cityId) {
                $.ajax({
                    url: "/user/get_streets/",
                    type: "GET",
                    data: { city_id: cityId },
                    headers: { "X-CSRFToken": getCSRFToken() },
                    success: function (data) {
                        streetSelect.empty().append('<option value="">–ò–∑–±–µ—Ä–µ—Ç–µ —É–ª–∏—Ü–∞</option>');
                        data.streets.forEach(street => {
                            streetSelect.append(`<option value="${street.id}">${street.street_name}</option>`);
                        });
                    }
                });
            }
        });
    });
</script>

{% endblock %}
